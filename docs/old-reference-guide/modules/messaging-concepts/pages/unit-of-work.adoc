= Processing Lifecycle and Context

The processing of a message is seen as a single unit in Axon Framework.
The `ProcessingContext` and `ProcessingLifecycle` interfaces coordinate actions performed during the processing of a message (command, event or query).
Although in most cases you are unlikely to interact with these directly, they are fundamental concepts used by the building blocks that Axon Framework provides.

The `ProcessingLifecycle` interface describes methods to register actions into distinct phases of processing.
The `ProcessingContext` extends `ProcessingLifecycle` and adds resource management capabilities.

You can access the `ProcessingContext` in your message handlers by adding it as a parameter to your annotated methods.
For example:

[source,java]
----
@CommandHandler
public void handle(MyCommand command, ProcessingContext context) {
    // Your command handling logic
    context.onCommit(() -> {
        // Actions to perform during commit phase
    });
}
----

== Resource management

The `ProcessingContext` provides resource management capabilities for attaching resources that need to be reused during the course of message processing.
Resources can be registered and retrieved using the context's resource management methods.

[source,java]
----
@EventHandler
public void handle(MyEvent event, ProcessingContext context) {
    MyResource resource = context.getOrComputeResource(
        "resourceKey",
        key -> new MyResource()
    );
    // Use the resource
}
----


== Processing phases

The `ProcessingLifecycle` defines several phases during message processing:

* **Pre-invocation phase** - Actions registered here are executed before the message handler is invoked
* **Invocation phase** - The actual message handler execution
* **Post-invocation phase** - Actions registered here are executed after the message handler completes
* **Prepare-commit phase** - Preparation actions before committing changes
* **Commit phase** - Where changes are committed
* **After-commit phase** - Actions executed after successful commit

Phases are ordered using integers, with space between them to allow adding actions before, after, or during any phase.
You can register actions for specific phases using the `ProcessingLifecycle` methods.

[NOTE]
.Transaction guarantees
====
The processing lifecycle is merely a coordination mechanism, not a replacement for transactions.
Although all staged changes are only committed when processing completes successfully, the commit is not atomic.
That means that when a commit fails, some changes might have been persisted, while others have not been.
Best practices dictate that a command should never contain more than one action.
If you stick to that practice, processing will contain a single action, making it safe to use as-is.
If you have more actions in your processing, then you could consider attaching a transaction.
Use `context.onCommit(..)` to register actions that need to be taken during the commit phase.
====

== Error handling

Your handlers may throw an Exception as a result of processing a message.
The `ProcessingLifecycle` provides methods to register error handling actions:

* `onError()` - Registers an action to be taken when an error occurs
* `whenComplete()` - Registers an action to be performed after successful processing
* `doFinally()` - Registers an action that is performed on both success and failure

[source,java]
----
@CommandHandler
public void handle(MyCommand command, ProcessingContext context) {
    context.onError(throwable -> {
        // Handle error, for example, cleanup or logging
    });

    context.whenComplete(result -> {
        // Action on successful completion
    });

    context.doFinally(() -> {
        // Always executed, regardless of success or failure
    });

    // Your command handling logic
}
----

By default, unchecked exceptions will cause processing to fail and scheduled side effects are cancelled.

== Automatic lifecycle management

When using framework components to process messages, the processing lifecycle is automatically managed for you.
The `ProcessingContext` is created, passed to your handlers, and properly completed by the framework.

The message handling process can be considered an atomic procedure; it should either be processed entirely, or not at all.
Axon Framework uses the processing lifecycle to track actions performed by message handlers.
After the handler has completed, Axon will try to commit the actions registered with the context.

== Transaction management

It is possible to bind a transaction to the processing lifecycle.
Many components, such as the `CommandBus` and `QueryBus` implementations and all asynchronously processing `EventProcessor`s, allow you to configure a `TransactionManager`.
This transaction manager will then be used to create the transactions to bind to the processing context that is used to manage the process of a message.

When application components need resources at different stages of message processing, such as a database connection or an `EntityManager`, these resources can be attached to the `ProcessingContext`.
The `context.getResources()` method allows you to access the resources attached to the current context.
Several helper methods are available on the context directly, to make working with resources easier.
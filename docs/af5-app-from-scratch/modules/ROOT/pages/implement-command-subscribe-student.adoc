:navtitle: Feature: Subscribe Student
:reftext: Implementing the subscribe student feature

As you may notice that we haven't implemented other things between `CreateCourse` and the `SubscribeStudent` commands.
It's a great benefit of the Axon Framework 5 together with Vertical Slices!
As long as you keep your `State` needed to validate the command private for the given slice you're only shared code between slices are events, which are the backbone of our system - contract between different parts.

== Define messages

As before let's look at Event Modeling.
Which events do we need for this slice to fulfill the Given-When-Then specifications?

image::EventModeling_GWT_SubscribeStudent.png[]

In previous section we've defined the `CourseCreated` events, so there are two left from the specification.
Let's define them as Java records, as before.

[source,java]
.src/main/java/io/axoniq/demo/university/faculty/events/StudentSubscribed.java
----
package io.axoniq.demo.university.faculty.events;

import org.axonframework.eventsourcing.annotations.EventTag;

public record StudentEnrolledFaculty(
        @EventTag // <1>
        String studentId,
        String firstName,
        String lastName
) {

}
----

<.> Always remember about marking which properties are event tags.
It's needed when you load state based on events.
If you used Aggregate approach before the Tag identifies the aggregate, but thanks to Dynamic Consistency Boundary you may how one event assigned to many business entities (not just once as before).

[source,java]
.src/main/java/io/axoniq/demo/university/faculty/events/StudentSubscribed.java
----
package io.axoniq.demo.university.faculty.events;

import org.axonframework.eventsourcing.annotations.EventTag;

public record StudentSubscribed(
        @EventTag // <1>
        String studentId,
        @EventTag // <1>
        String courseId
) {
}
----

<.> Thanks to those annotations the event will be tagged with `studentId` and `courseId`, so everytime when you define your event criteria to retrieve certain state you can TBD...
It's a good example that StudentSubscribed event is connected to two business entities - Student and the Course.
When domain experts says that "student subscribed" they know, that because of the event the course free spots decreased and also student subscription limit may be reached.

Last, but not least we define the command.

[source,java]
.src/main/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudent.java
----
package io.axoniq.demo.university.faculty.write.createcourse;

import io.axoniq.demo.university.faculty.write.StudentId;
import io.axoniq.demo.university.faculty.write.CourseId;

public record SubscribeStudent(StudentId studentId, CourseId courseId) {
}
----

== Specification by example

As you remember from the previous section we do not focus on entities, but on behavior.
So we're going to describe our feature in Given-When-Then manner based on commands and events.
Let's create the first test case using Axon Test Fixture.
We're going to translate the Event Modeling specification, which you've seen on the top of the page + other test cases for this slice, to the code.

[source,java]
.src/test/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudentTest.java
----
package io.axoniq.demo.university.faculty.write.createcourse;

import java.util.UUID;

class SubscribeStudentTest {

    private AxonTestFixture fixture;

    @BeforeEach
    void beforeEach() {
        fixture = AxonTestFixture.with(UniversityAxonApplication.configurer());
    }

    @Test
    void successfulSubscription() {
        var courseId = CourseId.random();
        var studentId = StudentId.random();

        fixture.given()
               .event(new CourseCreated(courseId.raw(), "Event Sourcing in Practice", 2))
               .event(new StudentEnrolledFaculty(studentId.raw(), "Mateusz", "Nowak"))
               .when()
               .command(new SubscribeStudent(studentId, courseId))
               .then()
               .events(new StudentSubscribed(studentId.raw(), courseId.raw()));
    }

    @Test
    void studentAlreadySubscribed() {
        var courseId = CourseId.random();
        var studentId = StudentId.random();

        fixture.given()
               .event(new StudentEnrolledFaculty(studentId.raw(), "Allard", "Buijze"))
               .event(new CourseCreated(courseId.raw(), "Axon Framework 5: Be a PRO", 2))
               .event(new StudentSubscribed(studentId.raw(), courseId.raw()))
               .when()
               .command(new SubscribeStudent(studentId, courseId))
               .then()
               .exception(RuntimeException.class, "Student already subscribed to this course");
    }

    @Test
    void courseFullyBooked() {
        var courseId = CourseId.random();
        var student1Id = StudentId.random();
        var student2Id = StudentId.random();
        var student3Id = StudentId.random();

        fixture.given()
               .event(new StudentEnrolledFaculty(student1Id.raw(), "Mateusz", "Nowak"))
               .event(new StudentEnrolledFaculty(student2Id.raw(), "Steven", "van Beelen"))
               .event(new StudentEnrolledFaculty(student3Id.raw(), "Mitchell", "Herrijgers"))
               .event(new CourseCreated(courseId.raw(), "Event Sourcing Masterclass", 2))
               .event(new StudentSubscribed(student1Id.raw(), courseId.raw()))
               .event(new StudentSubscribed(student2Id.raw(), courseId.raw()))
               .when()
               .command(new SubscribeStudent(student3Id, courseId))
               .then()
               .exception(RuntimeException.class, "Course is fully booked");
    }

}
----

To those tests we need to implement the command handler for `SubscribeStudent` command.
As you've seen for the behaviour which is based on some state (so we have something in Given section of the test) we need to have State for our command handler to validate commands againts it.
Let's make it right away!

[source,java]
.src/main/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudent.java
----
package io.axoniq.demo.university.faculty.write.subscribestudent;

import java.util.UUID;

class SubscribeStudentCommandHandler {



}
----
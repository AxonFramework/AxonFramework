= Advanced Use Cases
:navtitle: Advanced use cases

It's possible to change the default enqueue behavior. You can do so by implementing the `EnqueuePolicy` interface.
For example like this:

[source,java]
----
import org.axonframework.messaging.deadletter.DeadLetter;
import org.axonframework.messaging.deadletter.Decisions;
import org.axonframework.messaging.deadletter.EnqueueDecision;
import org.axonframework.messaging.deadletter.EnqueuePolicy;
import org.axonframework.messaging.eventhandling.EventMessage;

import java.time.Duration;
import java.time.Instant;

public class CustomEnqueuePolicy implements EnqueuePolicy<EventMessage> {
    @Override
    public EnqueueDecision<EventMessage> decide(DeadLetter<? extends EventMessage> letter, Throwable cause) {
        if (cause instanceof NullPointerException) {
            return Decisions.doNotEnqueue(); // <1>
        }
        if (letter.message().getPayload() instanceof NotificationEvent &&
                letter.enqueuedAt().isAfter(Instant.now().plus(Duration.ofMinutes(5L)))) {
            return Decisions.evict(); // <2>
        }
        return Decisions.enqueue(cause); // <3>
    }
}
----

<1> No need to put this in a dead letter queue.
As this always creates the same `NullPointerException`, don't enqueue it.
<2> If it's a notification event, which is already in the queue for 5 minutes, evict the event so it's not retried again.
<3> Default to enqueue the event message again.

Below is another example that uses the diagnostics and evicts after trying 5 times:

[source,java]
----
import org.axonframework.messaging.deadletter.DeadLetter;
import org.axonframework.messaging.deadletter.Decisions;
import org.axonframework.messaging.deadletter.EnqueueDecision;
import org.axonframework.messaging.deadletter.EnqueuePolicy;
import org.axonframework.messaging.eventhandling.EventMessage;

public class RetryLimitEnqueuePolicy implements EnqueuePolicy<EventMessage> {
    @Override
    public EnqueueDecision<EventMessage> decide(DeadLetter<? extends EventMessage> letter, Throwable cause) {
        final int retries = (int) letter.diagnostics().getOrDefault("retries", -1); // <1>
        if (retries < 5) {
            return Decisions.requeue(cause, l -> l.diagnostics().and("retries", retries + 1)); // <2>
        }
        return Decisions.evict(); // <3>
    }
}
----

<1> Get the retries, default to -1. So on entering the queue, the value is 0.
<2> Requeue, increasing the retries.
<3> Once it's retried 5 times, the framework evicts the event message.

== Configuring the enqueue policy

You can set the policy through the `deadLetterQueue(...)` configuration.
You can set a default policy for all processors and override it for specific ones.

[source,java]
----
public class EventProcessingDlqConfig {

    public void configureEventProcessing(MessagingConfigurer configurer) {
        configurer.eventProcessing(eventConfigurer -> eventConfigurer.pooledStreaming(
                pooledStreamingConfigurer -> pooledStreamingConfigurer
                        // Set default DLQ policy for all processors
                        .defaults((cfg, processorConfig) -> processorConfig
                                .deadLetterQueue(dlq -> dlq
                                        .enabled()
                                        .enqueuePolicy(new RetryLimitEnqueuePolicy())
                                )
                        )
                        // Override policy for a specific processor
                        .processor(
                                "notification-processor",
                                config -> config.eventHandlingComponents(/*components omitted*/)
                                                .customize((cfg, processorCfg) -> processorCfg
                                                        .deadLetterQueue(dlq -> dlq
                                                                .enqueuePolicy(new CustomEnqueuePolicy())
                                                        )
                                                )
                        )
        ));
    }
}
----

== Accessing dead letter context in event handlers

When processing dead letters, the `ProcessingContext` contains the `DeadLetter` as a resource:

[source,java]
----
public class SampleEventHandler {

    public void handle(SomeEvent event, ProcessingContext context) {
        DeadLetter<EventMessage> deadLetter = context.getResource(DeadLetter.RESOURCE_KEY);
        if (deadLetter != null) {
            // This is a dead-letter retry
            int retries = (int) deadLetter.diagnostics().getOrDefault("retries", 0);
            Throwable originalCause = deadLetter.cause().orElse(null);
            // Adjust handling based on retry count or original cause
        } else {
            // Normal event handling
        }
    }
}
----
